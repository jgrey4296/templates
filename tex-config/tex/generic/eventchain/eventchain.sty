%% __sty -*- mode: LaTeX -*-

% Package ID:
\ProvidesPackage{eventchain}
\NeedsTeXFormat{LaTeX2e}

%-- Options

%%-- imports
\RequirePackage{calc}
\RequirePackage{etoolbox}
\RequirePackage{longtable}
\RequirePackage{tikz}
\RequirePackage{etoolbox}
\RequirePackage{environ}
\RequirePackage{ulem}
\RequirePackage{keyval}

\usetikzlibrary{graphdrawing}
\usetikzlibrary{shadows}
\usetikzlibrary{decorations}
\usetikzlibrary{shapes}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{calc}
\usetikzlibrary{fit}
\usetikzlibrary{backgrounds}
\usetikzlibrary{positioning}
\usetikzlibrary{chains}
\usetikzlibrary{scopes}
% \usetikzlibrary{graphs}

%%-- end imports

%-- Variables
% \newlength{\eventchainWidth}
% \setlength{\eventchainWidth}{5cm}

\define@key{eventchain@keys}{dir}{\def\eventchain@dir{#1}}
\define@key{eventchain@keys}{dist}{\def\eventchain@dist{#1}}
\define@key{eventchain@keys}{start}{\def\eventchain@start{#1}}
\define@key{event@keys}{name}{\def\event@name{#1}}
\define@key{event@keys}{dist}{\def\event@dist{#1}}
\define@key{fluents@keys}{name}{\def\fluents@name{#1}}
\define@key{fluents@keys}{dist}{\def\fluents@dist{#1}}

\directlua{ eventchain = require ("eventchain") }

%-- Environments
\NewEnviron{eventchain}[1][]{
  \setkeys{eventchain@keys}{dir=below, dist=1cm, start=-1, #1}
  % internal commands
  \providecommand{\jumpto}[1][nil]{% Insert an Ellipses Node and increment time by [1]
    \directlua{ current:continue("##1") }
  }
  \providecommand{\state}[1][nil]{
    \directlua{ current:node("##1") }
  }
  \providecommand{\addfluent}[1]{+ & \texttt{\textbf{##1}}}
  \providecommand{\subfluent}[1]{- & \sout{\texttt{##1}}}
  \providecommand{\keepfluent}[1]{= & \texttt{##1}}
  
  % internal environments
  \NewEnviron{event}[1][]{
    %% Insert Event descriptions in between states, and increment the time step
    \setkeys{event@keys}{name=Evc, dist=2cm, ##1}
    \directlua{ current:change_open("\event@name", "\event@dist") }
    \BODY
    \directlua{ current:change_close() }
  }

  \NewEnviron{fluents}[1][]{
    %% Annotate a state with fluent addition,retraction,and continuation
    \setkeys{fluents@keys}{name=Fl, dist=2cm, ##1}
    \directlua{ current:fluents_open ("\fluents@name", "\fluents@dist") }
    \BODY
    \directlua{ current:fluents_close () }
  }
  
  % actual output
  \directlua{ current = eventchain:new("\eventchain@dir", "\eventchain@dist", "\eventchain@start") }
  \BODY
  \directlua{ current = current:close() }
}



